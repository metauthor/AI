# Output generated by @ua_chatgpt_bot

Ваше питання: /start

Відповідь: -compute.sh

# Store the output in an environment variable
IP_ADDRESS=$(bash ../start-compute.sh | awk '{print $NF}')

#Wait for all of the API checks to finish
sleep 120

# Verify VM is running
if ! timeout 10 bash -c " while ! nc -z $IP_ADDRESS 22; do sleep 10; done"; then
    echo "VM did not start in time"
    exit 1
fi

echo "Waiting for any pending updates to finish"
sleep 300

#Run Ansible Ping
ansible all -i $IP_ADDRESS, -m ping -u ubuntu
if [ $? -eq 0 ]
  then
    echo "Ansible Ping successful"
  else
    echo "Ansible Ping failed"
fi

#Run Heat Template Validation
heat template-validate heat/compliance-infra.yaml
if [ $? -eq 0 ]
  then
    echo "Heat Template Validation successful"
  else
    echo "Heat Template Validation failed"
fi

# Create Overcloud stack
heat stack-create -f heat/compliance-infra.yaml overcloud

# Check Heat Stack Create
if [ $? -eq 0 ]
then
  echo "Heat Stack Create was successful"
else
  echo "Heat Stack Create failed"
fi

#echo "Waiting 20 minutes for stack to fully boot up"
#sleep 1200


# Upload SSH Key
ssh-keygen -f test-key -N ''
openstack keypair create --public-key test-key.pub test-key

#Run Ansible playbook
ansible-playbook -i $IP_ADDRESS, ./ansible/compliance-jenkins.yml
if [ $? -eq 0 ]
  then
    echo "Ansible Playbook executed successfully"
  else
    echo "Ansible Playbook failed to execute"
fi

#Tear down new infrastructure
heat stack-delete -y overcloud

